const i="http://localhost";class o{retryCount=0;maxRetries=5;checkInterval=5*60*1e3;listeners=[];currentStatus={status:"online",lastSync:Date.now(),pendingCount:0,retryCount:0};async checkBackendStatus(){try{return(await fetch(`${i}:8770/health`,{method:"GET",mode:"cors",signal:AbortSignal.timeout(3e3)})).ok}catch{return!1}}async getPendingPosts(){return(await chrome.storage.local.get("pendingPosts")).pendingPosts||[]}async sendToBackend(t,s){try{return(await fetch(`${i}:8770/api/posts/batch`,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify({posts:t,filtered:s||[]})})).ok}catch{return!1}}async markAsSynced(t){const e=(await chrome.storage.local.get("pendingPosts")).pendingPosts||[],r=new Set(t.map(a=>a.id)),n=e.filter(a=>!r.has(a.id));await chrome.storage.local.set({pendingPosts:n,syncStatus:n.length===0?"synced":"pending"}),this.updatePendingCount(n.length)}async updatePendingCount(t){this.currentStatus.pendingCount=t,this.notifyListeners(),t>0?(await chrome.action.setBadgeText({text:String(t)}),await chrome.action.setBadgeBackgroundColor({color:"#FFAD1F"})):await chrome.action.setBadgeText({text:""})}notifyListeners(){this.listeners.forEach(t=>t(this.currentStatus))}onStatusChange(t){this.listeners.push(t),t(this.currentStatus)}async syncPendingData(){if(!await this.checkBackendStatus()){this.retryCount++,this.currentStatus.status="offline",this.currentStatus.retryCount=this.retryCount,this.notifyListeners(),console.log(`[Sync] Backend offline, retry ${this.retryCount}/${this.maxRetries}`);return}const s=await this.getPendingPosts();s.length>0?(this.currentStatus.status="syncing",this.notifyListeners(),await this.sendToBackend(s)?(await this.markAsSynced(s),this.retryCount=0,this.currentStatus.status="online",this.currentStatus.lastSync=Date.now(),console.log(`[Sync] Synced ${s.length} posts to backend`)):console.log("[Sync] Failed to sync posts")):(this.currentStatus.status="online",this.retryCount=0),this.notifyListeners()}async manualSync(){if(this.currentStatus.status="syncing",this.notifyListeners(),!await this.checkBackendStatus())return this.currentStatus.status="offline",this.notifyListeners(),{status:"failed",remote:!1,error:"Backend unavailable"};const s=await this.getPendingPosts();return s.length===0?(this.currentStatus.status="online",this.notifyListeners(),{status:"synced",remote:!0}):await this.sendToBackend(s)?(await this.markAsSynced(s),this.currentStatus.status="online",this.currentStatus.lastSync=Date.now(),this.notifyListeners(),{status:"synced",remote:!0}):(this.currentStatus.status="offline",this.notifyListeners(),{status:"failed",remote:!1,error:"Sync failed"})}startAutoSync(){console.log("[Sync] Starting auto sync (interval: 5 minutes)"),this.syncPendingData(),setInterval(()=>this.syncPendingData(),this.checkInterval)}getStatus(){return{...this.currentStatus}}}const u=new o;export{u as s};
