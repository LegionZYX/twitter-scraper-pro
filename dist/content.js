class y{constructor(e,t,r={debounceMs:100}){this.target=e,this.callback=t,this.options=r}observer=null;debounceTimer=null;isRunning=!1;start(){this.isRunning||(this.observer=new MutationObserver(e=>{this.handleMutations(e)}),this.observer.observe(this.target,{childList:this.options.childList??!0,subtree:this.options.subtree??!0,attributes:this.options.attributes??!1}),this.isRunning=!0)}handleMutations(e){this.options.selector&&this.filterBySelector(e).length===0||(this.options.debounceMs>0?this.debounce(e):this.callback(e))}filterBySelector(e){return e.filter(t=>{for(const r of Array.from(t.addedNodes))if(r instanceof HTMLElement&&(r.matches?.(this.options.selector)||r.querySelector?.(this.options.selector)))return!0;return!1})}debounce(e){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.callback(e),this.debounceTimer=null},this.options.debounceMs)}destroy(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.observer?.disconnect(),this.observer=null,this.isRunning=!1}}class S{static SELECTORS={tweet:[{tier:"primary",css:'article[data-testid="tweet"]',description:"Standard tweet article element",version:"2023-2025"},{tier:"secondary",css:'article[role="article"]',description:"Tweet via role attribute",version:"2023-2025"},{tier:"fallback",css:'div[data-testid="cellInnerDiv"] article',description:"Nested tweet in cell structure",version:"2023-2025"}],author:[{tier:"primary",css:'[data-testid="User-Name"]',description:"Username container",version:"2023-2025"},{tier:"secondary",css:'a[href^="/"][role="link"]',description:"Author via link pattern",version:"2022-2025"},{tier:"fallback",css:'[data-testid="UserAvatar"]',description:"Avatar container",version:"2023-2025"}],timestamp:[{tier:"primary",css:"time[datetime]",description:"Time element with datetime attr",version:"2022-2025"},{tier:"secondary",css:'a[href*="/status/"] time',description:"Time inside status link",version:"2023-2025"},{tier:"fallback",css:'[data-testid="timestamp"]',description:"Timestamp testid",version:"2024-2025"}],content:[{tier:"primary",css:'[data-testid="tweetText"]',description:"Tweet text container",version:"2023-2025"},{tier:"secondary",css:"div[lang]",description:"Language-marked text div",version:"2022-2025"},{tier:"fallback",css:'[data-testid="tweet"] div[dir="auto"]',description:"Auto-direction text div",version:"2022-2025"}],engagement:[{tier:"primary",css:'[data-testid="reply"]',description:"Reply button",version:"2023-2025"},{tier:"secondary",css:'[data-testid="retweet"]',description:"Retweet button",version:"2023-2025"},{tier:"fallback",css:'[data-testid="like"]',description:"Like button",version:"2023-2025"}],avatar:[{tier:"primary",css:'[data-testid="Tweet-User-Avatar"] img',description:"User avatar image",version:"2023-2025"},{tier:"secondary",css:'img[src*="profile_images"]',description:"Avatar via profile URL pattern",version:"2022-2025"},{tier:"fallback",css:'[data-testid="UserAvatar"] img',description:"User avatar container img",version:"2023-2025"}],media:[{tier:"primary",css:'[data-testid="tweetPhoto"] img',description:"Tweet photo",version:"2023-2025"},{tier:"secondary",css:'[data-testid="videoPlayer"]',description:"Video player",version:"2023-2025"},{tier:"fallback",css:'[data-testid="tweet"] img:not([alt=""])',description:"Any non-empty image in tweet",version:"2023-2025"}]};static getSelectors(e){return this.SELECTORS[e]||[]}static getPrimary(e){return this.SELECTORS[e]?.[0]?.css||""}static getAllTargets(){return Object.keys(this.SELECTORS)}}class w{healthMap=new Map;check(e,t=document.body){const i=t.querySelectorAll(e).length,s=i>0,a=this.healthMap.get(e)||{failures:0,lastCheck:new Date,lastHealthy:null};return s?(a.failures=0,a.lastHealthy=new Date):a.failures++,a.lastCheck=new Date,this.healthMap.set(e,a),{selector:e,healthy:s,count:i,consecutiveFailures:a.failures,lastChecked:a.lastCheck}}getHealth(e){const t=this.healthMap.get(e);return t?{selector:e,healthy:t.failures===0,count:0,consecutiveFailures:t.failures,lastChecked:t.lastCheck}:null}getUnhealthySelectors(){const e=[];return this.healthMap.forEach((t,r)=>{t.failures>=3&&e.push(r)}),e}resetAll(){this.healthMap.clear()}}class b{health=new w;scrapeTweet(e){try{const t=this.findTweetElement(e);if(!t)return console.warn("[TwitterScraper] No tweet element found"),null;const r=this.extractTweetId(t);if(!r)return console.warn("[TwitterScraper] No tweet ID found"),null;const i=this.extractContent(t),s=this.extractAuthor(t),a=this.extractTimestamp(t),o=this.extractEngagement(t),n=this.extractMedia(t);return i||console.warn("[TwitterScraper] Empty content for tweet:",r),{id:r,author:s,content:i,timestamp:a,engagement:o,media:n}}catch(t){return console.error("[TwitterScraper] Error scraping tweet:",t),null}}findTweetElement(e){if(e.matches?.('article[data-testid="tweet"]')||e.matches?.('article[role="article"]'))return e;const t=e.querySelector('article[data-testid="tweet"]');return t||e.querySelector("article")||null}findElement(e,t){const r=S.getSelectors(t);for(const i of r){const s=this.trySelector(e,i);if(s)return i.css&&this.health.check(i.css,e),s}return null}trySelector(e,t){if(t.css)try{const r=e.querySelector(t.css);if(r)return r}catch{}if(t.xpath)try{const r=document.evaluate(t.xpath,e,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);if(r.singleNodeValue instanceof Element)return r.singleNodeValue}catch{}return null}extractTweetId(e){const t=e.querySelector('a[href*="/status/"]');if(t){const s=(t.getAttribute("href")||"").match(/\/status\/(\d+)/);if(s)return s[1]}const r=e.querySelector('[data-testid="tweet"] a, article a[href*="/status/"]');if(r){const s=(r.getAttribute("href")||"").match(/\/status\/(\d+)/);if(s)return s[1]}return""}extractContent(e){let t="";const r=e.querySelector('[data-testid="tweetText"]');if(r?.textContent&&(t=r.textContent.trim()),!t){const i=e.querySelector("div[lang]");i?.textContent&&(t=i.textContent.trim())}if(!t){const i=e.querySelectorAll("span");for(const s of i){const a=s.textContent?.trim()||"";if(a.length>20&&!a.startsWith("@")&&!a.includes("Replying to")){t=a;break}}}if(!t){const s=(e.textContent||"").split(`
`).map(a=>a.trim()).filter(a=>a.length>10);s.length>0&&(t=s[0])}return t}extractAuthor(e){let t="",r="";const i=e.querySelector('[data-testid="User-Name"]');if(i){const s=i.querySelector('a[href^="/"]');s&&(t=(s.getAttribute("href")||"").replace("/","").split("/")[0]);const a=i.querySelectorAll("span");for(const o of a){const n=o.textContent?.trim()||"";if(n&&!n.startsWith("@")&&n.length>0&&n.length<50){r=n;break}}}if(!t){const s=e.querySelectorAll('a[href^="/"]');for(const a of s){const o=a.getAttribute("href")||"";if(o.startsWith("/")&&!o.includes("/status/")&&!o.includes("reply")&&(t=o.replace("/","").split("/")[0],t))break}}return{username:t,displayName:r}}extractTimestamp(e){const t=e.querySelector("time[datetime]");if(t)return t.getAttribute("datetime")||"";const r=e.querySelector('a[href*="/status/"] time');if(r){const i=r.closest("time");if(i)return i.getAttribute("datetime")||""}return""}extractEngagement(e){return{replies:this.parseEngagementCount(e,"reply"),retweets:this.parseEngagementCount(e,"retweet"),likes:this.parseEngagementCount(e,"like")}}parseEngagementCount(e,t){const r=e.querySelector(`[data-testid="${t}"]`);if(!r)return 0;const s=(r.getAttribute("aria-label")||"").match(/(\d+)/);if(s)return parseInt(s[1],10);const a=r.querySelectorAll("span");for(const o of a){const n=o.textContent?.trim()||"";if(/^\d/.test(n))return this.parseCount(n)}return 0}parseCount(e){const t=e.replace(/,/g,"").replace(/\s/g,"");if(t.includes("K")||t.includes("k")){const r=parseFloat(t.replace(/[Kk]/g,""));return Math.round(r*1e3)}if(t.includes("M")||t.includes("m")){const r=parseFloat(t.replace(/[Mm]/g,""));return Math.round(r*1e6)}return parseInt(t,10)||0}extractMedia(e){const t=[];return e.querySelectorAll('[data-testid="tweetPhoto"] img').forEach(i=>{const s=i.getAttribute("src");s&&t.push(s)}),t.length===0&&e.querySelectorAll('img[src*="pbs.twimg.com"], img[src*="twimg.com"]').forEach(s=>{const a=s.getAttribute("src");a&&!a.includes("profile_images")&&!a.includes("emoji")&&t.push(a)}),t}}class x{platform="reddit";scrapePost(e){try{const t=this.extractPostData(e);return t?{id:t.id,platform:this.platform,author:t.author.username,authorDisplayName:t.author.username,content:t.content,title:t.title,subreddit:t.subreddit,timestamp:t.timestamp,score:t.engagement.upvotes,upvotes:t.engagement.upvotes,downvotes:0,replies:t.engagement.comments,url:this.buildPostUrl(t.id,t.subreddit),media:t.media,scrapedAt:Date.now()}:null}catch(t){return console.error("[RedditScraper] Error scraping post:",t),null}}findPostElement(e){if(e.tagName.toLowerCase()==="shreddit-post"||e.matches?.('shreddit-post, [data-testid="post-container"], article[data-post-id]'))return e;const t=e.closest?.("shreddit-post")||e.closest?.('[data-testid="post-container"]')||e.closest?.("article[data-post-id]");return t||e.querySelector?.("shreddit-post")||e.querySelector?.('[data-testid="post-container"]')||e.querySelector?.("article[data-post-id]")||null}extractPostData(e){const t=this.findPostElement(e);if(!t)return console.warn("[RedditScraper] No post element found"),null;const r=this.extractId(t);if(!r)return console.warn("[RedditScraper] No post ID found"),null;const i=this.extractTitle(t),s=this.extractContent(t),a=this.extractAuthor(t),o=this.extractEngagement(t),n=this.extractSubreddit(t),f=this.extractTimestamp(t),g=this.extractMedia(t);return{id:r,title:i,content:s,author:a,engagement:o,subreddit:n,timestamp:f,media:g}}extractId(e){const t=e.getAttribute("post-id")||e.getAttribute("data-post-id")||e.getAttribute("data-fullname")||"";if(t)return t;const r=e.querySelector('a[href*="/comments/"]');if(r){const s=(r.getAttribute("href")||"").match(/\/comments\/(\w+)/);if(s)return s[1]}return""}extractTitle(e){return e.querySelector('h3[slot="title"], h3, a[data-click-id="title"], .shreddit-title')?.textContent?.trim()||""}extractContent(e){let t="";const r=e.querySelector('div[data-click-id="text"], .md, .post-content, shreddit-post-text');if(r&&(t=r.textContent?.trim()||""),!t){const i=e.querySelector('[data-testid="post-preview"], .preview-text');i&&(t=i.textContent?.trim()||"")}if(!t){const s=(e.textContent||"").split(`
`).map(a=>a.trim()).filter(a=>a.length>10);s.length>0&&(t=s[0])}return t}extractAuthor(e){const t=e.querySelector('a[data-click-id="user"], a[data-click-id="author"], .author, shreddit-author');let r="";if(t&&(r=(t.getAttribute("href")||"").replace("/user/","").replace("/u/","").split("/")[0],r||(r=t.getAttribute("name")||t.textContent?.trim()||"")),!r){const i=e.querySelectorAll('a[href^="/user/"], a[href^="/u/"]');for(const s of i){const a=s.getAttribute("href")||"";if((a.startsWith("/user/")||a.startsWith("/u/"))&&(r=a.split("/")[2]||"",r))break}}return{username:r||"[deleted]"}}extractEngagement(e){const t=this.extractUpvotes(e),r=this.extractComments(e),i=this.extractAwards(e);return{upvotes:t,comments:r,awards:i}}extractUpvotes(e){const t=e.querySelector('button[aria-label*="upvote"], [slot="vote-up"], .score');if(t){const s=(t.getAttribute("aria-label")||t.textContent||"").match(/(\d+[kKMM]?\d*)/);if(s)return this.parseCount(s[1])}const r=e.querySelector('[data-click-id="score"], .score, shreddit-post');if(r){const i=r.getAttribute("score");if(i)return parseInt(i,10)}return 0}extractComments(e){const t=e.querySelector('a[data-click-id="comments"], .comments, footer a[href*="/comments/"]');if(t){const i=(t.textContent||"").match(/(\d+)/);if(i)return parseInt(i[1],10)}return 0}extractAwards(e){return e.querySelectorAll('shreddit-award, .award, [data-testid="award"]').length}extractSubreddit(e){const t=e.querySelector('a[data-click-id="subreddit"], a[href^="/r/"]');return t?(t.getAttribute("href")||"").replace("/r/","").split("/")[0]:""}extractTimestamp(e){const t=e.querySelector("time[datetime]");if(t)return t.getAttribute("datetime")||"";const r=e.querySelector('.timestamp, [data-click-id="timestamp"]');if(r){const i=r.textContent?.trim()||"";if(i){const s=i.match(/(\d+)\s*(seconds?|minutes?|hours?|days?|weeks?|months?|years?)/i);if(s){const a=parseInt(s[1],10),o=s[2].toLowerCase(),n=new Date;return o.startsWith("second")?n.setSeconds(n.getSeconds()-a):o.startsWith("minute")?n.setMinutes(n.getMinutes()-a):o.startsWith("hour")?n.setHours(n.getHours()-a):o.startsWith("day")?n.setDate(n.getDate()-a):o.startsWith("week")?n.setDate(n.getDate()-a*7):o.startsWith("month")?n.setMonth(n.getMonth()-a):o.startsWith("year")&&n.setFullYear(n.getFullYear()-a),n.toISOString()}}}return new Date().toISOString()}extractMedia(e){const t=[];return e.querySelectorAll('img[src]:not([src*="avatar"]):not([src*="icon"])').forEach(s=>{const a=s.getAttribute("src")||"";a&&a.startsWith("http")&&!a.includes("style")&&t.push(a)}),e.querySelectorAll("video[src], source[src]").forEach(s=>{const a=s.getAttribute("src")||"";a&&!t.includes(a)&&t.push(a)}),t}parseCount(e){const t=e.replace(/,/g,"").replace(/\s/g,"");if(t.toLowerCase().includes("k")){const r=parseFloat(t.toLowerCase().replace("k",""));return Math.round(r*1e3)}if(t.toLowerCase().includes("m")){const r=parseFloat(t.toLowerCase().replace("m",""));return Math.round(r*1e6)}return parseInt(t,10)||0}buildPostUrl(e,t){return`https://reddit.com/r/${t}/comments/${e}`}}let l="twitter";const v=new b,E=new x;let u=null;function A(){return location.hostname.includes("reddit.com")?"reddit":"twitter"}function d(){l=A(),console.log(`[SocialScraper] Initializing on ${l}...`);let c,e;l==="reddit"?(c=document.querySelector("main, #SHORTCUT_FOCUSABLE_DIV")||document.body,e='shreddit-post, [data-testid="post-container"], article[data-post-id]'):(c=document.querySelector('[data-testid="primaryColumn"], main')||document.body,e='article[data-testid="tweet"], article[role="article"]'),u=new y(c,async()=>{const t=h();t.length>0&&(console.log(`[SocialScraper] Scraped ${t.length} posts on ${l}`),chrome.runtime.sendMessage({type:"POSTS_SCRAPED",posts:t}).catch(r=>console.warn("[SocialScraper] Failed to send posts:",r)))},{debounceMs:500,selector:e,childList:!0,subtree:!0}),u.start(),setTimeout(()=>{const t=h();t.length>0&&(console.log(`[SocialScraper] Initial scrape: ${t.length} posts`),chrome.runtime.sendMessage({type:"POSTS_SCRAPED",posts:t}).catch(r=>console.warn("[SocialScraper] Failed to send initial posts:",r)))},1e3)}function h(){let c;l==="reddit"?c=document.querySelectorAll('shreddit-post, [data-testid="post-container"], article[data-post-id]'):c=document.querySelectorAll('article[data-testid="tweet"], article[role="article"]');const e=[],t=new Set;return c.forEach(r=>{try{let i;if(l==="reddit")i=E.scrapePost(r);else{const s=v.scrapeTweet(r);s?i={id:s.id,platform:"twitter",author:s.author.username,authorDisplayName:s.author.displayName,content:s.content,timestamp:s.timestamp,score:s.engagement.likes,replies:s.engagement.replies,url:T(s.id,"twitter",s.author.username),media:s.media,scrapedAt:Date.now()}:i=null}i&&i.id&&!t.has(i.id)&&(t.add(i.id),e.push(i))}catch(i){console.warn("[SocialScraper] Failed to scrape post:",i)}}),e}function T(c,e,t){return`https://twitter.com/${t||"i"}/status/${c}`}function m(){u?.destroy(),u=null}let p=location.href;new MutationObserver(()=>{location.href!==p&&(p=location.href,m(),setTimeout(d,500))}).observe(document.body,{childList:!0,subtree:!0});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d();window.addEventListener("beforeunload",m);
